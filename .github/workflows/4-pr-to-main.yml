name: 3. Create PR to Main
on:
  workflow_call:
    inputs:
      merged-pr-number:
        required: true
        type: string
        description: 'Number of the PR that was merged to develop'

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Create unique release branch
        id: create-branch
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RELEASE_BRANCH="release/auto-${TIMESTAMP}"
          git checkout -b "${RELEASE_BRANCH}"
          echo "release_branch=${RELEASE_BRANCH}" >> $GITHUB_OUTPUT
          echo "âœ… Created release branch: ${RELEASE_BRANCH}"

      - name: Create Release Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.create-branch.outputs.release_branch }}
          base: main
          title: "ðŸš€ Release: develop â†’ main (Source: PR #${{ inputs['merged-pr-number'] }})"
          body: |
            ## Production Release Candidate

            This release promotes the latest state of `develop` to `main`.

            **Source Information**:
            - **Trigger PR**: #${{ inputs['merged-pr-number'] }}
            - **Release Branch**: `${{ steps.create-branch.outputs.release_branch }}`
            - **Generated**: $(date)

            ### ðŸ”— Related Links
            - [View source PR #${{ inputs['merged-pr-number'] }}](https://github.com/${{ github.repository }}/pull/${{ inputs['merged-pr-number'] }})
            - [Compare develop â†’ main](https://github.com/${{ github.repository }}/compare/main...develop)

            ### ðŸ“‹ Merge Checklist
            1. âœ… All CI checks passed on source PR
            2. âœ… Code review completed
            3. [ ] Final review of this release PR
            4. [ ] Merge to deploy to production

            ---
            \*Automatically generated after merge of PR #${{ inputs['merged-pr-number'] }} to develop\*
          labels: release,production,automated