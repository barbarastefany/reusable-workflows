name: 4. Create PR to Main

on:
  workflow_run:
    workflows: [ '3. Manual Merge PR to Develop' ]
    types: [ completed ]
  workflow_call:
    inputs:
      merged-pr-number:
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Create unique release branch
        id: create-branch
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RELEASE_BRANCH="release/auto-${TIMESTAMP}"
          git checkout -b "${RELEASE_BRANCH}"
          git push -u origin "${RELEASE_BRANCH}"
          echo "release_branch=${RELEASE_BRANCH}" >> $GITHUB_OUTPUT

      - name: Create PR develop -> main
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = `ðŸš€ Release: develop â†’ main (Source: PR #${{ inputs['merged-pr-number'] || 'N/A' }})`;
            const head = `${{ steps.create-branch.outputs.release_branch }}`;
            const base = 'main';
            try {
              // Try to create the PR
              const { data } = await github.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                head,
                base,
                maintainer_can_modify: true
              });
              core.info(`Created PR #${data.number}`);
              // Add labels
              await github.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: data.number,
                labels: ['release','production','automated']
              });
            } catch (e) {
              // If PR already exists, do nothing
              if (e.status === 422 && /A pull request already exists/i.test(e.message)) {
                core.info('PR jÃ¡ existe para esta branch.');
              } else {
                throw e;
              }
            }