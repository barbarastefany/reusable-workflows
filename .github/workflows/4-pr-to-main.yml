name: 4. Create PR to Main

on:
  workflow_call:
    inputs:
      merged-pr-number:
        required: true
        type: string
      base-branch:
        required: false
        type: string
        default: 'develop'
      target-branch:
        required: false
        type: string
        default: 'main'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base-branch }}
          fetch-depth: 0

      - name: Create unique release branch
        id: create-branch
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RELEASE_BRANCH="release/auto-${TIMESTAMP}"
          git checkout -b "${RELEASE_BRANCH}"
          git push -u origin "${RELEASE_BRANCH}"
          echo "release_branch=${RELEASE_BRANCH}" >> $GITHUB_OUTPUT

      - name: Create PR base â†’ target
        uses: actions/github-script@v7
        env:
          RELEASE_BRANCH: ${{ steps.create-branch.outputs.release_branch }}
          MERGED_PR_NUMBER: ${{ inputs.merged-pr-number }}
          SRC: ${{ inputs.base-branch }}
          BASE: ${{ inputs.target-branch }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const head = process.env.RELEASE_BRANCH;
            const base = process.env.BASE;
            const srcPr = process.env.MERGED_PR_NUMBER || 'N/A';
            const srcBranch = process.env.SRC;
            const title = `ðŸš€ Release: ${srcBranch} â†’ ${base} (Source: PR #${srcPr})`;

            try {
              const { data } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                head,
                base,
                maintainer_can_modify: true
              });
              core.info(`Created PR #${data.number}`);

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: data.number,
                labels: ['release','production','automated']
              });
            } catch (e) {
              if (e.status === 422 && /A pull request already exists/i.test(e.message)) {
                core.info('PR jÃ¡ existe para esta branch.');
              } else {
                throw e;
              }
            }