name: 4. Create PR to Main

on:
  workflow_call:
    inputs:
      merged-pr-number:
        required: true
        type: string
      base-branch:
        required: true
        type: string
        default: 'develop'
      target-branch:
        required: true
        type: string
        default: 'main'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr-develop-to-main:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base-branch }}
          fetch-depth: 0

      - name: Create PR develop â†’ main
        uses: actions/github-script@v7
        env:
          MERGED_PR_NUMBER: ${{ inputs.merged-pr-number }}
          SRC: ${{ inputs.base-branch }}
          BASE: ${{ inputs.target-branch }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const head = process.env.SRC;   // develop
            const base = process.env.BASE;  // main
            const srcPr = process.env.MERGED_PR_NUMBER || 'N/A';
            const title = `ðŸš€ Release: ${head} â†’ ${base} (Source: PR #${srcPr})`;

            try {
              const { data } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                head,
                base,
                maintainer_can_modify: true
              });
              core.info(`Created PR #${data.number}`);

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: data.number,
                labels: ['release','production','automated']
              });
            } catch (e) {
              if (e.status === 422 && /A pull request already exists/i.test(e.message)) {
                core.info('PR jÃ¡ existe entre develop e main.');
              } else {
                throw e;
              }
            }