name: Create PR to main

on:
  workflow_call:
    inputs:
      source-branch:
        description: "Branch de origem (ex.: develop)"
        required: true
        # removed default to avoid unintended triggers
        type: string
      target-branch:
        description: "Branch alvo do PR (padrão main)"
        required: false
        default: "main"
        type: string
      pr-title:
        description: "Título do PR"
        required: false
        default: ""
        type: string
      pr-body:
        description: "Corpo/descrição do PR"
        required: false
        default: ""
        type: string
      github-token:
        description: "Token para criar o PR (opcional, padrão GITHUB_TOKEN)"
        required: false
        default: ""
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}
      pr_url: ${{ steps.pr.outputs.pr_url }}
      created: ${{ steps.pr.outputs.created }}
    steps:
      - name: Create PR from source to target
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ inputs.github-token != '' && inputs.github-token || github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Use strictly the provided inputs
            const head = `${{ inputs.source-branch }}`.trim().replace(/^refs\/heads\//, '');
            const base = `${{ inputs.target-branch }}`.trim().replace(/^refs\/heads\//, '');
            const titleInput = `${{ inputs.pr-title }}`;
            const bodyInput = `${{ inputs.pr-body }}`;

            if (!head) {
              core.setFailed('Branch de origem não fornecida.');
              return;
            }
            if (!base) {
              core.setFailed('Branch alvo não fornecida.');
              return;
            }

            if (head !== 'develop' && base === 'main') {
              core.setFailed(`Esta rotina foi projetada para criar PR de 'develop' para 'main'. Recebido head='${head}'.`);
              return;
            }

            async function branchExists(branch) {
              try {
                await github.rest.git.getRef({ owner, repo, ref: `heads/${branch}` });
                return true;
              } catch (e) {
                if (e.status === 404) return false;
                throw e;
              }
            }

            // Validate branches exist
            if (!(await branchExists(head))) {
              core.setFailed(`Branch de origem não encontrada: ${head}`);
              return;
            }
            if (!(await branchExists(base))) {
              core.setFailed(`Branch alvo não encontrada: ${base}`);
              return;
            }

            core.info(`Verificando PRs abertos: ${head} -> ${base}...`);
            const existing = await github.paginate(github.rest.pulls.list, {
              owner, repo, state: 'open', base, head: `${owner}:${head}`
            });
            if (existing.length > 0) {
              const pr = existing[0];
              core.info(`PR já existe: #${pr.number} (${pr.html_url})`);
              core.setOutput('pr_number', String(pr.number));
              core.setOutput('pr_url', pr.html_url);
              core.setOutput('created', 'false');
              return;
            }

            const title = (titleInput && titleInput.trim()) || `PR criado automaticamente: merge ${head} → ${base}`;
            let body = (bodyInput || '').trim();
            const runLink = `${process.env.GITHUB_SERVER_URL}/${owner}/${repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            body = body ? `${body}\n\nCI Run: ${runLink}` : `CI Run: ${runLink}`;

            try {
              const { data: pr } = await github.rest.pulls.create({ owner, repo, base, head, title, body, maintainer_can_modify: true, draft: false });
              core.info(`PR criado: #${pr.number} (${pr.html_url})`);
              core.setOutput('pr_number', String(pr.number));
              core.setOutput('pr_url', pr.html_url);
              core.setOutput('created', 'true');
            } catch (err) {
              if (err.status === 422) {
                // Race/duplicate: recheck and surface existing PR
                const retry = await github.paginate(github.rest.pulls.list, { owner, repo, state: 'open', base, head: `${owner}:${head}` });
                if (retry.length > 0) {
                  const pr = retry[0];
                  core.info(`PR encontrado após rechecagem: #${pr.number} (${pr.html_url})`);
                  core.setOutput('pr_number', String(pr.number));
                  core.setOutput('pr_url', pr.html_url);
                  core.setOutput('created', 'false');
                  return;
                }
              }
              throw err;
            }
