name: 3. Create PR to Main
on:
  workflow_call:

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Criar tag de vers√£o autom√°tica
        id: version
        run: |
          # Gera vers√£o baseada na data
          VERSION="release-$(date +%Y%m%d-%H%M%S)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Cria arquivo de release
          echo "# Release $VERSION" > RELEASE.md
          echo "Data: $(date)" >> RELEASE.md
          echo "Branch: develop" >> RELEASE.md
          git add RELEASE.md
          
          # Configura git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Commit apenas se houver mudan√ßas
          git diff --cached --quiet || git commit -m "chore: release $VERSION [skip ci]"

      - name: Push do commit de release (se houver)
        if: success()
        run: |
          # Verifica se h√° commits para push
          if git log origin/develop..HEAD --oneline | grep -q .; then
            git push origin develop
            echo "‚úÖ Commit de release pushed"
          else
            echo "‚ö†Ô∏è Nenhum commit novo para push"
          fi

      - name: Create PR to main
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: develop
          base: main
          title: "üöÄ Release: ${{ steps.version.outputs.version }}"
          body: |
            ## Release Autom√°tico - ${{ steps.version.outputs.version }}
            
            Criado automaticamente ap√≥s merge em develop.
            
            **Data**: $(date)
            
            ### üìù Notas
            Este PR inclui todas as features aprovadas em develop.
          labels: release,production,automated